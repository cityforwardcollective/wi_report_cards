---
format: 
  html:
    echo: false
    message: false
    error: false
    warning: false
    backgroundcolor: transparent
---

```{r message=FALSE}
library(reactable)
library(tidyverse)
library(sf)
library(glue)

base <- "https://cityforwardcollective.github.io/wi_report_cards/report_cards"

full_table <- read_rds("data/full_table.rda")

this_theme <- function() {
  reactableTheme(
    searchInputStyle = list(
      width = "100%"
    ),
    style = list(
      padding = "10px",
      minHeight = "650"
    )
  )
}

vacants <- function(value) {

  if (value == "Vacant") {
    args <- list(value, style = glue("color: {'grey90'}; font-weight: 700"))
  } 
  do.call(span, args)
}

col2hex <- function(x, alpha = FALSE) {
  args <- as.data.frame(t(col2rgb(x, alpha = alpha)))
  args <- c(args, list(names = x, maxColorValue = 255))
  do.call(rgb, args)
}

# full_table |> 
#   mutate(district = ifelse(broad_agency_type == "Private", glue("{district} Private"), district)) |> 
#   transmute(this = glue(
#     '{base}/{district}/{school_name} {school_year}.pdf'
#   ))

charter <- c(
  "2r/2x Charter",
  "Non-Instrumentality Charter"
)
trad <- c(
  "Traditional Public",
  "Instrumentality Charter"
)


full_table |> 
  mutate(
    district = ifelse(broad_agency_type == "Private", glue("{district} Private"), district),
    report_card_type = ifelse(broad_agency_type != "Private", "All Students", report_card_type),
    sector = case_when(
      accurate_agency_type %in% charter ~ "Public Charter School",
      accurate_agency_type %in% trad ~ "Traditional Public School",
      TRUE ~ glue("{accurate_agency_type} School")
    ),
    "Report Card Link" = case_when(accurate_agency_type == "Private" ~ glue(
    "<a href='{base}/{district}/{school_name} {report_card_type} School Report Card {school_year}.pdf'",
                            "target='_blank'>{report_card_type}</a>"
                            ),
                            TRUE ~ glue(
    "<a href='{base}/{district}/{school_name} School Report Card {school_year}.pdf'",
                            "target='_blank'>{report_card_type}</a>"
                            ))) |> 
  select("School Year" = school_year,
         District = district,
         School = school_name,
         Sector = sector,
         `Report Card Link`) |>



  reactable(elementId = "myTable", columns = list(
    District = colDef(),
    `Report Card Type` = colDef(
      style = function(value) {
        if (value == "Vacant") {
          list(color = glue("{col2hex('grey60')}"), fontStyle = "italic")
        } 
        
      }
    ),
    `Report Card Link` = colDef(html = TRUE, 
                           style = list(fontSize = ".75rem"),
                           minWidth = 125),
    Sector = colDef()
  ), 
  searchable = TRUE, 
  highlight = TRUE, 
  showPageSizeOptions = TRUE, 
  language = reactableLang(
    searchPlaceholder = "Search district, school, or sector"
    ),
  defaultColDef = colDef(align = "center"),
  theme = this_theme())

```




